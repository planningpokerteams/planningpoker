<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Phase de jeu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body class="landing-body">
    <!-- NAVBAR -->
    <header class="navbar">
        <div class="nav-inner">
            <div class="logo">
                <span class="logo-mark">‚ô†</span>
                <span class="logo-text">Poker Planning</span>
            </div>

            <nav class="nav-links">
                <a href="/">Accueil</a>
                <a href="/create">Cr√©er une session</a>
                <a href="/join">Rejoindre</a>
            </nav>

            <div class="nav-actions">
                <a href="/join" class="btn btn-ghost">Rejoindre</a>
                <a href="/create" class="btn btn-primary">Nouvelle session</a>
            </div>
        </div>
    </header>

    <!-- TABLE DE JEU -->
    <main class="hero">
        <div class="hero-inner game-layout">
            <!-- Zone de jeu / cartes -->
            <section class="hero-card game-table">
                <h1>Estimation en cours</h1>
                <p class="hero-subtitle" id="story-text">
                    Chargement de la user story‚Ä¶
                </p>

                <!-- Cartes de vote -->
                <form id="vote-form" method="post">
                    <input type="hidden" name="vote" id="vote-input">

                    <div class="cards-row">
                        {% for value in [1, 2, 3, 5, 8, 13] %}
                        <button
                            type="button"
                            class="poker-card"
                            data-value="{{ value }}"
                        >
                            {{ value }}
                        </button>
                        {% endfor %}
                    </div>
                </form>

                <p id="vote-status" class="hero-small" style="margin-top: 10px;">
                    Clique sur une carte pour voter.
                </p>

                {% if is_organizer %}
                <form id="reveal-form" method="post" action="{{ url_for('reveal', session_id=session_id) }}" style="margin-top: 18px;">
                    <input type="hidden" name="username" value="{{ current_user }}">
                    <button
                        type="submit"
                        id="reveal-button"
                        class="btn btn-primary full-width"
                        disabled
                    >
                        R√©v√©ler les cartes
                    </button>
                </form>
                <p class="hero-small" id="reveal-hint" style="margin-top: 6px;">
                    Le bouton se d√©bloque quand tout le monde a vot√©.
                </p>
                {% else %}
                <p class="hero-small" style="margin-top: 18px;">
                    En attente que l‚Äôorganisateur r√©v√®le les cartes‚Ä¶
                </p>
                {% endif %}
            </section>

            <!-- Table des joueurs -->
            <section class="hero-card players-card">
                <h2>Table de jeu</h2>
                <ul id="players-table">
                    {% for p in participants %}
                    <li class="player-slot">
                        <img
                            class="avatar-icon"
                            src="https://api.dicebear.com/9.x/avataaars/svg?seed={{ p.avatarSeed or 'astronaut' }}&backgroundColor=b6e3f4&radius=50"
                            alt="avatar de {{ p.name }}"
                        >
                        <div class="player-info">
                            <span class="player-name">{{ p.name }}</span>
                            <span class="player-vote">
                                {% if p.vote is none %}
                                    ‚è≥ En attente
                                {% else %}
                                    ‚úÖ A vot√©
                                {% endif %}
                            </span>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </section>
        </div>
    </main>

    <script>
        const sessionId   = "{{ session_id }}";
        const currentUser = "{{ current_user }}";
        const isOrganizer = "{{ is_organizer }}".toLowerCase() === "true";
        const cards         = document.querySelectorAll('.poker-card');
        const voteInput     = document.getElementById('vote-input');
        const voteForm      = document.getElementById('vote-form');
        const voteStatusEl  = document.getElementById('vote-status');
        const playersTable  = document.getElementById('players-table');
        const storyTextEl   = document.getElementById('story-text');
        const revealButton  = document.getElementById('reveal-button');
        const revealHint    = document.getElementById('reveal-hint');

        // --- S√©lection de carte ---
        cards.forEach(card => {
            card.addEventListener('click', () => {
                const value = card.getAttribute('data-value');
                voteInput.value = value;

                // Visuel : on marque la carte s√©lectionn√©e
                cards.forEach(c => c.classList.remove('poker-card--selected'));
                card.classList.add('poker-card--selected');

                voteStatusEl.textContent = `Tu as choisi la carte ${value}. Vote envoy√©‚Ä¶`;
                voteForm.submit();
            });
        });

        // --- Rafra√Æchissement r√©gulier de l'√©tat de jeu ---
        function refreshGameState() {
            fetch(`/api/game/${sessionId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error("Erreur API game:", data.error);
                        return;
                    }

                    // 1. Met √† jour la user story
                    if (storyTextEl) {
                        storyTextEl.textContent = data.currentStory || "Aucune user story.";
                    }

                    // 2. Met √† jour la table des joueurs
                    playersTable.innerHTML = "";
                    let meHasVoted = false;

                    (data.participants || []).forEach(p => {
                        const li = document.createElement('li');
                        li.className = "player-slot";

                        const img = document.createElement('img');
                        img.className = "avatar-icon";
                        img.src = `https://api.dicebear.com/9.x/avataaars/svg?seed=${encodeURIComponent(p.avatarSeed || 'astronaut')}&backgroundColor=b6e3f4&radius=50`;
                        img.alt = `avatar de ${p.name}`;

                        const info = document.createElement('div');
                        info.className = "player-info";

                        const nameSpan = document.createElement('span');
                        nameSpan.className = "player-name";
                        nameSpan.textContent = p.name;

                        const voteSpan = document.createElement('span');
                        voteSpan.className = "player-vote";

                        if (!data.reveal) {
                            // Avant r√©v√©lation : on ne montre pas les valeurs
                            voteSpan.textContent = p.hasVoted ? "‚úÖ A vot√©" : "‚è≥ En attente";
                        } else {
                            // Apr√®s r√©v√©lation : on montre les valeurs
                            if (p.vote !== null && p.vote !== undefined) {
                                voteSpan.textContent = `üÉè ${p.vote}`;
                            } else {
                                voteSpan.textContent = "‚Äî";
                            }
                        }

                        info.appendChild(nameSpan);
                        info.appendChild(voteSpan);
                        li.appendChild(img);
                        li.appendChild(info);
                        playersTable.appendChild(li);

                        if (p.name === currentUser && p.hasVoted) {
                            meHasVoted = true;
                        }
                    });

                    // 3. Texte de statut utilisateur
                    if (!data.reveal) {
                        if (meHasVoted) {
                            voteStatusEl.textContent = "Ton vote est pris en compte. En attente des autres joueurs‚Ä¶";
                        } else {
                            voteStatusEl.textContent = "Clique sur une carte pour voter.";
                        }
                    } else {
                        voteStatusEl.textContent = "Les cartes ont √©t√© r√©v√©l√©es.";
                    }

                    // 4. Gestion du bouton R√©v√©ler (organisateur uniquement)
                    if (isOrganizer && revealButton) {
                        if (data.reveal) {
                            revealButton.disabled = true;
                            if (revealHint) revealHint.textContent = "Les cartes sont r√©v√©l√©es.";
                        } else {
                            // On n‚Äôactive le bouton que si tout le monde a vot√©
                            revealButton.disabled = !data.allVoted;
                            if (revealHint) {
                                revealHint.textContent = data.allVoted
                                    ? "Tout le monde a vot√©, tu peux r√©v√©ler les cartes."
                                    : "Le bouton se d√©bloque quand tout le monde a vot√©.";
                            }
                        }
                    }
                })
                .catch(err => {
                    console.error("Erreur lors du rafra√Æchissement de la partie", err);
                });
        }

        refreshGameState();
        setInterval(refreshGameState, 3000);
    </script>
</body>
</html>
