<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Phase de jeu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body class="landing-body">

    <!-- HISTORIQUE √Ä GAUCHE -->
    <aside class="history-panel">
        <h3>Historique</h3>
        <ul id="history-list"></ul>
    </aside>

    <!-- NAVBAR -->
    <header class="navbar">
        <div class="nav-inner">
            <div class="logo">
                <span class="logo-mark">‚ô†</span>
                <span class="logo-text">Poker Planning</span>
            </div>

            <nav class="nav-links">
                <a href="/">Accueil</a>
                <a href="/create">Cr√©er une session</a>
                <a href="/join">Rejoindre</a>
            </nav>

            <div class="nav-actions">
                <a href="/join" class="btn btn-ghost">Rejoindre</a>
                <a href="/create" class="btn btn-primary">Nouvelle session</a>
            </div>
        </div>
    </header>

    <!-- CONTENU -->
    <main class="game-main">

        <!-- STORY EN GROS -->
        <section class="game-header">
            <h1 id="story-text" class="big-story-text">
                Chargement de la user story‚Ä¶
            </h1>
        </section>

        <!-- TABLE DE POKER -->
        <section class="game-table-wrapper">
            <div id="poker-table" class="poker-table">
                <div class="table-center">
                    <div class="table-logo">‚ô†</div>
                    <div class="table-center-text">
                        <p class="table-title">Poker Planning</p>
                        <p id="table-status-text" class="table-status">
                            Clique sur une carte pour voter.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ACTIONS -->
        <section class="game-actions">

            <!-- BOUTON R√âV√âLATION -->
            {% if is_organizer %}
            <form id="reveal-form"
                  method="post"
                  action="{{ url_for('reveal', session_id=session_id) }}">
                <button id="reveal-button"
                        type="submit"
                        class="btn btn-primary reveal-btn"
                        disabled>
                    R√©v√©ler les cartes
                </button>
            </form>
            <p id="reveal-hint" class="hero-small">En attente des votes‚Ä¶</p>
            {% endif %}

            <!-- TEXTES D'√âTAT -->
            <p id="game-status-text" class="hero-small vote-status-text"></p>

            <!-- BOUTONS GM -->
            {% if is_organizer %}
            <button id="next-button"
                    class="btn btn-primary gm-action"
                    style="display:none;">
                Passer √† la user story suivante
            </button>

            <button id="revote-button"
                    class="btn btn-secondary gm-action"
                    style="display:none;">
                Relancer le vote
            </button>

            <button id="force-next-button"
                    class="btn btn-danger gm-action"
                    style="display:none;">
                Passer quand m√™me
            </button>
            {% endif %}

            <!-- CARTES -->
            <form id="vote-form" method="post">
                <input type="hidden" name="vote" id="vote-input">
                <div class="cards-row cards-row-big">
                    {% for value in [1, 2, 3, 5, 8, 13] %}
                    <button type="button"
                            class="poker-card poker-card-big"
                            data-value="{{ value }}">
                        <span class="card-value">{{ value }}</span>
                    </button>
                    {% endfor %}
                </div>
            </form>

        </section>

    </main>

    <script>
        const sessionId      = "{{ session_id }}";
        const currentUser    = "{{ current_user }}";
        const isOrganizer    = "{{ is_organizer }}".toLowerCase() === "true";

        const cards          = document.querySelectorAll('.poker-card');
        const voteInput      = document.getElementById('vote-input');
        const voteForm       = document.getElementById('vote-form');

        const storyTextEl    = document.getElementById('story-text');
        const pokerTable     = document.getElementById('poker-table');
        const tableStatus    = document.getElementById('table-status-text');

        const revealButton   = document.getElementById('reveal-button');
        const revealHint     = document.getElementById('reveal-hint');

        const gameStatusText = document.getElementById('game-status-text');

        const nextBtn        = document.getElementById('next-button');
        const revoteBtn      = document.getElementById('revote-button');
        const forceNextBtn   = document.getElementById('force-next-button');

        const historyList    = document.getElementById('history-list');


        /* -------------------------------
           S√âLECTION DES CARTES
        --------------------------------*/
        cards.forEach(card => {
            card.addEventListener('click', () => {
                const value = card.getAttribute('data-value');

                cards.forEach(c => c.classList.remove('poker-card--selected'));
                card.classList.add('poker-card--selected');

                voteInput.value = value;
                gameStatusText.textContent = `Tu as vot√© : ${value}`;

                voteForm.submit();
            });
        });


        /* -------------------------------
           PLACEMENT DES JOUEURS AUTOUR
        --------------------------------*/
        function layoutSeats() {
            const seats = pokerTable.querySelectorAll('.player-seat');
            if (!seats.length) return;

            const w = pokerTable.clientWidth;
            const h = pokerTable.clientHeight;
            const cx = w / 2;
            const cy = h / 2;
            const radius = Math.min(cx, cy) - 70;

            seats.forEach((seat, i) => {
                const angle = (i / seats.length) * Math.PI * 2 - Math.PI / 2;
                seat.style.left = `${cx + radius * Math.cos(angle)}px`;
                seat.style.top  = `${cy + radius * Math.sin(angle)}px`;
            });
        }


        /* -------------------------------
           CONSENSUS
        --------------------------------*/
        function evaluateConsensus(votes) {
            const fib = [1,2,3,5,8,13,21];
            const sorted = [...votes].sort((a,b)=>a-b);

            const min = sorted[0];
            const max = sorted[sorted.length-1];

            if (min === max) return "consensus";

            const iMin = fib.indexOf(min);
            const iMax = fib.indexOf(max);

            if (iMin !== -1 && iMax !== -1 && Math.abs(iMin - iMax) === 1)
                return "soft";

            return "none";
        }


        /* -------------------------------
           API POLLING
        --------------------------------*/
        function refreshGameState() {

            fetch(`/api/game/${sessionId}`)
                .then(r => r.json())
                .then(data => {

                    if (data.error) return;

                    /* STORY */
                    storyTextEl.textContent = data.currentStory || "";

                    /* HISTORIQUE */
                    historyList.innerHTML = "";
                    data.history.forEach(h => {
                        historyList.innerHTML += `
                            <li>
                                <strong>${h.story}</strong><br>
                                Vote : ${h.result}
                            </li>
                        `;
                    });

                    /* PLAYERS */
                    pokerTable.querySelectorAll('.player-seat').forEach(n => n.remove());

                    let meHasVoted = false;

                    data.participants.forEach(p => {
                        const seat = document.createElement("div");
                        seat.className = "player-seat";
                        if (p.hasVoted) seat.classList.add("has-voted");

                        const img = document.createElement("img");
                        img.className = "player-avatar";
                        img.src = `https://api.dicebear.com/9.x/avataaars/svg?seed=${p.avatarSeed}`;
                        seat.appendChild(img);

                        const name = document.createElement("div");
                        name.className = "player-name";
                        name.textContent = p.name;
                        seat.appendChild(name);

                        const s = document.createElement("div");
                        s.className = "player-status";

                        if (data.reveal) {
                            seat.classList.add("revealed");
                            s.textContent = p.vote ?? "‚Äî";
                        } else {
                            s.textContent = p.hasVoted ? "A vot√©" : "En attente";
                        }

                        seat.appendChild(s);
                        pokerTable.appendChild(seat);

                        if (p.name === currentUser && p.hasVoted)
                            meHasVoted = true;
                    });

                    layoutSeats();


                    /* ---------------------
                       AVANT R√âV√âLATION
                    ---------------------*/
                    if (!data.reveal) {

                        if (meHasVoted)
                            gameStatusText.textContent = "Ton vote est enregistr√©.";
                        else
                            gameStatusText.textContent = "Clique sur une carte pour voter.";

                        if (isOrganizer) {
                            revealButton.disabled = !data.allVoted;
                            revealHint.textContent =
                                data.allVoted ? "Tout le monde a vot√© !" : "En attente des votes...";
                        }

                        nextBtn.style.display = "none";
                        revoteBtn.style.display = "none";
                        forceNextBtn.style.display = "none";
                    }


                    /* ---------------------
                       APR√àS R√âV√âLATION
                    ---------------------*/
                    if (data.reveal) {

                        const votes = data.participants
                            .filter(p => p.vote !== null)
                            .map(p => parseInt(p.vote));

                        const consensus = evaluateConsensus(votes);

                        if (consensus === "consensus") {
                            gameStatusText.textContent = "‚úÖ Consensus parfait !";
                            if (isOrganizer) {
                                nextBtn.style.display = "block";
                            }
                        }
                        else if (consensus === "soft") {
                            gameStatusText.textContent = "üü¶ Consensus acceptable.";
                            if (isOrganizer) {
                                nextBtn.style.display = "block";
                                revoteBtn.style.display = "block";
                            }
                        }
                        else {
                            gameStatusText.textContent = "‚ùå Pas de consensus.";
                            if (isOrganizer) {
                                revoteBtn.style.display = "block";
                                forceNextBtn.style.display = "block";
                            }
                        }
                    }

                });
        }


        setInterval(refreshGameState, 2000);
        refreshGameState();
        window.addEventListener("resize", layoutSeats);


        /* -------------------------------
           ACTIONS GM
        --------------------------------*/
        if (nextBtn) {
            nextBtn.addEventListener("click", () => {
                fetch(`/next_story/${sessionId}`, { method: "POST" })
                    .then(()=> refreshGameState());
            });
        }

        if (revoteBtn) {
            revoteBtn.addEventListener("click", () => {
                fetch(`/revote/${sessionId}`, { method: "POST" })
                    .then(()=> refreshGameState());
            });
        }

        if (forceNextBtn) {
            forceNextBtn.addEventListener("click", () => {
                fetch(`/next_story/${sessionId}`, { method: "POST" })
                    .then(()=> refreshGameState());
            });
        }

    </script>

</body>
</html>
